<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoteMail - Self-Destructing Email Sharing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 50%, #fef2f2 100%);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gradient-button {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
    }
    
    .gradient-button:hover {
      background: linear-gradient(135deg, #7e22ce 0%, #db2777 100%);
    }
    
    @keyframes pulse-flame {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .flame-pulse {
      animation: pulse-flame 2s ease-in-out infinite;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div id="app"></div>

  <script type="module">
    import React from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';
    import { useState, useEffect } from 'https://esm.sh/react@18';

    const NOTEMAIL_API = 'http://localhost:5001/api/notemail';
    const TEMPMAIL_API = 'http://localhost:5000/api';

    // Icons as SVG components
    const FlameIcon = () => (
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
      </svg>
    );

    const MailIcon = () => (
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
    );

    const SendIcon = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    );

    const CheckIcon = () => (
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
      </svg>
    );

    const AlertIcon = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    );

    const ArrowLeftIcon = () => (
      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    );

    function NoteMail() {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const [noteId, setNoteId] = useState('');
      const [encryptionKey, setEncryptionKey] = useState('');
      const [noteContent, setNoteContent] = useState(null);
      const [destroyed, setDestroyed] = useState(false);
      
      const [showReply, setShowReply] = useState(false);
      const [replySubject, setReplySubject] = useState('');
      const [replyMessage, setReplyMessage] = useState('');
      const [replySent, setReplySent] = useState(false);

      useEffect(() => {
        const path = window.location.pathname;
        const hash = window.location.hash;
        
        if (path.includes('/view/') && hash) {
          const id = path.split('/view/')[1];
          const key = hash.substring(1);
          
          if (id && key) {
            setNoteId(id);
            setEncryptionKey(key);
            viewNote(id, key);
          }
        }
      }, []);

      const viewNote = async (id, key) => {
        setLoading(true);
        setError('');
        
        try {
          const response = await fetch(`${NOTEMAIL_API}/view/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key })
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to load note');
          }

          const data = await response.json();
          setNoteContent(data.content);
          setDestroyed(data.metadata.willDestroy);
          
          const originalSubject = data.content.subject;
          setReplySubject(originalSubject.startsWith('Re: ') ? originalSubject : `Re: ${originalSubject}`);
          
        } catch (err) {
          setError(err.message || 'This note has been destroyed or never existed.');
        } finally {
          setLoading(false);
        }
      };

      const sendReply = async () => {
        if (!replyMessage.trim()) {
          alert('Please enter a message');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const response = await fetch(`${TEMPMAIL_API}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: noteContent.replyTo,
              from: 'Anonymous Reply',
              subject: replySubject,
              body: replyMessage
            })
          });

          if (!response.ok) throw new Error('Failed to send reply');

          setReplySent(true);
          setShowReply(false);
          
        } catch (err) {
          setError('Failed to send reply. The email may have expired.');
        } finally {
          setLoading(false);
        }
      };

      return React.createElement('div', { className: 'min-h-screen' },
        // Header
        React.createElement('header', { className: 'bg-white border-b border-gray-200 shadow-sm' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8' },
            React.createElement('div', { className: 'flex items-center justify-between' },
              React.createElement('div', { className: 'flex items-center space-x-3' },
                React.createElement('div', { className: 'gradient-button p-2.5 rounded-lg' },
                  React.createElement(FlameIcon, { className: 'text-white' })
                ),
                React.createElement('div', null,
                  React.createElement('h1', { className: 'text-2xl font-bold gradient-text' }, 'NoteMail'),
                  React.createElement('p', { className: 'text-xs text-gray-500' }, 'Self-Destructing Email')
                )
              ),
              React.createElement('a', { 
                href: '/', 
                className: 'text-sm text-gray-600 hover:text-gray-900 font-medium flex items-center space-x-1' 
              },
                React.createElement(ArrowLeftIcon),
                React.createElement('span', null, 'Back to TempMail')
              )
            )
          )
        ),

        // Main Content
        React.createElement('main', { className: 'max-w-4xl mx-auto px-4 py-12 sm:px-6 lg:px-8' },
          
          // Loading
          loading && !noteContent && React.createElement('div', { className: 'bg-white rounded-2xl p-12 border border-gray-200 shadow-lg text-center' },
            React.createElement('div', { className: 'flame-pulse mb-4 inline-block' },
              React.createElement(FlameIcon, { className: 'w-16 h-16 text-purple-600 mx-auto' })
            ),
            React.createElement('p', { className: 'text-gray-600 font-medium' }, 'Loading note...')
          ),

          // Error
          error && !noteContent && React.createElement('div', { className: 'bg-white rounded-2xl p-8 border border-gray-200 shadow-lg' },
            React.createElement('div', { className: 'text-center' },
              React.createElement('div', { className: 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4' },
                React.createElement(AlertIcon, { className: 'w-8 h-8 text-red-600' })
              ),
              React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 mb-2' }, 'Note Not Found'),
              React.createElement('p', { className: 'text-gray-600 mb-6' }, error),
              React.createElement('a', { 
                href: '/', 
                className: 'inline-flex items-center px-6 py-3 gradient-button text-white font-semibold rounded-lg transition-all' 
              },
                React.createElement(ArrowLeftIcon, { className: 'mr-2' }),
                'Go to TempMail'
              )
            )
          ),

          // Note Content
          noteContent && !showReply && React.createElement('div', { className: 'bg-white rounded-2xl p-8 border border-gray-200 shadow-lg' },
            // Destruction Warning
            destroyed && React.createElement('div', { className: 'mb-6 p-4 bg-red-50 border-2 border-red-200 rounded-lg flex items-start space-x-3' },
              React.createElement(FlameIcon, { className: 'w-6 h-6 text-red-600 flex-shrink-0 mt-0.5' }),
              React.createElement('div', null,
                React.createElement('p', { className: 'text-red-900 font-semibold' }, 'This note has been destroyed'),
                React.createElement('p', { className: 'text-red-700 text-sm mt-1' }, 
                  'This message will no longer be accessible. Save any important information now.'
                )
              )
            ),

            // Email Content
            React.createElement('div', { className: 'mb-6' },
              React.createElement('h2', { className: 'text-3xl font-bold text-gray-900 mb-4' }, noteContent.subject),
              React.createElement('div', { className: 'space-y-3 text-sm' },
                React.createElement('div', { className: 'flex items-start' },
                  React.createElement('span', { className: 'font-semibold text-gray-600 min-w-[80px]' }, 'From:'),
                  React.createElement('span', { className: 'text-gray-900 bg-gray-50 px-3 py-1.5 rounded-lg flex-1' }, noteContent.from)
                ),
                React.createElement('div', { className: 'flex items-start' },
                  React.createElement('span', { className: 'font-semibold text-gray-600 min-w-[80px]' }, 'To:'),
                  React.createElement('span', { className: 'text-gray-900 bg-gray-50 px-3 py-1.5 rounded-lg font-mono text-xs flex-1' }, noteContent.to)
                ),
                React.createElement('div', { className: 'flex items-start' },
                  React.createElement('span', { className: 'font-semibold text-gray-600 min-w-[80px]' }, 'Date:'),
                  React.createElement('span', { className: 'text-gray-900 bg-gray-50 px-3 py-1.5 rounded-lg flex-1' }, 
                    new Date(noteContent.timestamp).toLocaleString()
                  )
                )
              )
            ),

            // Email Body
            React.createElement('div', { className: 'border-t border-gray-200 pt-6 mb-6' },
              React.createElement('div', { className: 'bg-gray-50 rounded-lg p-6' },
                React.createElement('p', { className: 'text-gray-800 whitespace-pre-wrap leading-relaxed' }, noteContent.body)
              )
            ),

            // Reply Section
            !replySent && noteContent.replyTo && React.createElement('div', { className: 'border-t border-gray-200 pt-6' },
              React.createElement('div', { className: 'bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 border border-purple-200' },
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-2 flex items-center' },
                  React.createElement(MailIcon, { className: 'mr-2 text-purple-600' }),
                  'Want to reply?'
                ),
                React.createElement('p', { className: 'text-gray-600 text-sm mb-4' }, 
                  'Send a message back to the sender\'s temporary inbox'
                ),
                React.createElement('button', {
                  onClick: () => setShowReply(true),
                  className: 'w-full py-3 gradient-button text-white font-semibold rounded-lg transition-all shadow-md flex items-center justify-center space-x-2'
                },
                  React.createElement(SendIcon),
                  React.createElement('span', null, 'Write a Reply')
                )
              )
            ),

            // Reply Sent
            replySent && React.createElement('div', { className: 'border-t border-gray-200 pt-6' },
              React.createElement('div', { className: 'bg-green-50 rounded-lg p-6 border border-green-200 text-center' },
                React.createElement('div', { className: 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3' },
                  React.createElement(CheckIcon, { className: 'text-green-600' })
                ),
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-900 mb-2' }, 'Reply Sent!'),
                React.createElement('p', { className: 'text-gray-600 text-sm' }, 
                  'Your message has been delivered to the sender\'s temporary inbox.'
                )
              )
            )
          ),

          // Reply Form
          showReply && React.createElement('div', { className: 'bg-white rounded-2xl p-8 border border-gray-200 shadow-lg' },
            React.createElement('div', { className: 'flex items-center justify-between mb-6' },
              React.createElement('h2', { className: 'text-2xl font-bold text-gray-900' }, 'Write Your Reply'),
              React.createElement('button', {
                onClick: () => setShowReply(false),
                className: 'text-gray-600 hover:text-gray-900'
              },
                React.createElement(ArrowLeftIcon)
              )
            ),

            React.createElement('div', { className: 'space-y-4' },
              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-semibold text-gray-700 mb-2' }, 'Subject'),
                React.createElement('input', {
                  type: 'text',
                  value: replySubject,
                  onChange: (e) => setReplySubject(e.target.value),
                  className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none'
                })
              ),

              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-semibold text-gray-700 mb-2' }, 'Your Message'),
                React.createElement('textarea', {
                  rows: 8,
                  value: replyMessage,
                  onChange: (e) => setReplyMessage(e.target.value),
                  placeholder: 'Type your reply here...',
                  className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none resize-none'
                })
              ),

              React.createElement('div', { className: 'flex items-start space-x-2 bg-yellow-50 border border-yellow-200 rounded-lg p-4' },
                React.createElement(AlertIcon, { className: 'text-yellow-600 flex-shrink-0 mt-0.5' }),
                React.createElement('p', { className: 'text-sm text-yellow-800' }, 
                  'Your reply will be sent anonymously to the sender\'s temporary inbox.'
                )
              ),

              React.createElement('button', {
                onClick: sendReply,
                disabled: loading || !replyMessage.trim(),
                className: 'w-full py-4 gradient-button text-white font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg flex items-center justify-center space-x-2'
              },
                React.createElement(SendIcon),
                React.createElement('span', null, loading ? 'Sending...' : 'Send Reply')
              ),

              error && React.createElement('div', { className: 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm' }, error)
            )
          )
        ),

        // Footer
        React.createElement('footer', { className: 'mt-16 pb-8 border-t border-gray-200 bg-white' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 pt-8 text-center' },
            React.createElement('p', { className: 'text-sm text-gray-600' },
              React.createElement('strong', null, 'NoteMail'),
              ' - Secure, self-destructing email sharing'
            ),
            React.createElement('p', { className: 'text-xs text-gray-500 mt-2' }, 
              'This note has been destroyed and cannot be viewed again.'
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(React.createElement(NoteMail));
  </script>
</body>
</html>
